<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="page-id" content="peer-tutoring-platform">
<title>Piattaforma Peer Tutoring - IIS Meucci Mattei</title>
<style>
/* VARIABILI GLOBALI */
:root {
    --blu-paterno: #4A90E2;
    --rosa-materno: #E91E63;
    --verde-crescita: #4CAF50;
    --arancio: #FF9800;
    --grigio: #757575;
    --grigio-chiaro: #F5F5F5;
    --bianco: #FFFFFF;
    --testo: #333333;
    --ombra: 0 4px 6px rgba(0,0,0,0.1);
    --ombra-forte: 0 8px 16px rgba(0,0,0,0.2);
    --radius: 12px;
    --transition: all 0.3s ease;
}

/* RESET E BASE */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    color: var(--testo);
}

/* CONTAINER PRINCIPALE */
.app-container {
    max-width: 1200px;
    margin: 0 auto;
    background: var(--bianco);
    border-radius: var(--radius);
    box-shadow: var(--ombra-forte);
    overflow: hidden;
}

/* HEADER APPLICAZIONE */
.app-header {
    background: linear-gradient(135deg, var(--blu-paterno) 0%, var(--rosa-materno) 100%);
    color: var(--bianco);
    padding: 30px;
    text-align: center;
    position: relative;
}

.app-header h1 {
    font-size: 2.2rem;
    margin-bottom: 8px;
}

.app-header .subtitle {
    font-size: 1.1rem;
    opacity: 0.95;
}

.app-header .istituto {
    font-size: 0.9rem;
    margin-top: 5px;
    opacity: 0.85;
}

/* NAVIGATION TABS */
.nav-tabs {
    display: flex;
    background: var(--grigio-chiaro);
    border-bottom: 3px solid var(--verde-crescita);
}

.nav-tab {
    flex: 1;
    padding: 18px;
    text-align: center;
    cursor: pointer;
    background: transparent;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    color: var(--grigio);
    transition: var(--transition);
    border-bottom: 4px solid transparent;
}

.nav-tab:hover {
    background: rgba(74, 144, 226, 0.1);
}

.nav-tab.active {
    background: var(--bianco);
    color: var(--blu-paterno);
    border-bottom-color: var(--blu-paterno);
}

.nav-tab .tab-emoji {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 5px;
}

/* CONTENT AREA */
.content-area {
    padding: 40px 30px;
    min-height: 600px;
}

.page {
    display: none;
    animation: fadeInPage 0.5s ease-in;
}

.page.active {
    display: block;
}

@keyframes fadeInPage {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* DASHBOARD */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.dashboard-card {
    background: var(--grigio-chiaro);
    padding: 25px;
    border-radius: var(--radius);
    box-shadow: var(--ombra);
    transition: var(--transition);
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--ombra-forte);
}

.dashboard-card h3 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    color: var(--blu-paterno);
    display: flex;
    align-items: center;
    gap: 10px;
}

.dashboard-card .big-number {
    font-size: 3rem;
    font-weight: bold;
    color: var(--verde-crescita);
    text-align: center;
    margin: 20px 0;
}

.dashboard-card .label {
    text-align: center;
    color: var(--grigio);
    font-size: 0.95rem;
}

/* COPPIA INFO */
.coppia-info {
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    padding: 25px;
    border-radius: var(--radius);
    margin-bottom: 30px;
    border-left: 5px solid var(--blu-paterno);
}

.coppia-info.not-set {
    background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);
    border-left-color: var(--arancio);
}

.coppia-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    align-items: center;
}

.coppia-row label {
    font-weight: 600;
    min-width: 100px;
}

.coppia-row input {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: var(--transition);
}

.coppia-row input:focus {
    outline: none;
    border-color: var(--blu-paterno);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

/* PROGRESS BAR */
.progress-section {
    margin: 30px 0;
}

.progress-section h3 {
    margin-bottom: 15px;
    color: var(--testo);
}

.progress-bar-container {
    background: var(--grigio-chiaro);
    height: 30px;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--blu-paterno) 0%, var(--verde-crescita) 100%);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 12px;
}

.progress-bar-text {
    color: var(--bianco);
    font-weight: bold;
    font-size: 0.9rem;
}

/* FASI OVERVIEW */
.fasi-overview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 30px 0;
}

.fase-card {
    background: var(--grigio-chiaro);
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    border: 3px solid transparent;
    position: relative;
}

.fase-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--ombra-forte);
}

.fase-card.completata {
    border-color: var(--verde-crescita);
    background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
}

.fase-card.in-corso {
    border-color: var(--arancio);
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
}

.fase-card.bloccata {
    opacity: 0.5;
    cursor: not-allowed;
}

.fase-emoji {
    font-size: 3rem;
    margin-bottom: 15px;
}

.fase-card h4 {
    font-size: 1.3rem;
    margin-bottom: 10px;
    color: var(--blu-paterno);
}

.fase-status {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 10px;
}

.fase-status.completata {
    background: var(--verde-crescita);
    color: var(--bianco);
}

.fase-status.in-corso {
    background: var(--arancio);
    color: var(--bianco);
}

.fase-status.bloccata {
    background: var(--grigio);
    color: var(--bianco);
}

/* BADGE DISPLAY */
.badges-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin: 20px 0;
}

.badge-item {
    text-align: center;
    padding: 15px;
    background: var(--grigio-chiaro);
    border-radius: var(--radius);
    min-width: 100px;
    transition: var(--transition);
}

.badge-item:hover {
    transform: scale(1.05);
}

.badge-item.earned {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
}

.badge-item.locked {
    opacity: 0.3;
    filter: grayscale(100%);
}

.badge-emoji {
    font-size: 2.5rem;
    display: block;
    margin-bottom: 8px;
}

.badge-name {
    font-size: 0.85rem;
    font-weight: 600;
}

/* BUTTONS */
.btn {
    padding: 15px 30px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--ombra-forte);
}

.btn-primary {
    background: linear-gradient(135deg, var(--blu-paterno) 0%, var(--rosa-materno) 100%);
    color: var(--bianco);
}

.btn-success {
    background: var(--verde-crescita);
    color: var(--bianco);
}

.btn-secondary {
    background: var(--grigio-chiaro);
    color: var(--testo);
}

.btn-danger {
    background: #f44336;
    color: var(--bianco);
}

.btn:disabled {
    background: var(--grigio);
    cursor: not-allowed;
    transform: none;
}

/* INCONTRI LIST */
.incontri-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.incontro-item {
    background: var(--grigio-chiaro);
    padding: 20px;
    border-radius: var(--radius);
    border-left: 5px solid var(--grigio);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.incontro-item:hover {
    background: #e8e8e8;
    transform: translateX(5px);
}

.incontro-item.completato {
    border-left-color: var(--verde-crescita);
}

.incontro-item.in-corso {
    border-left-color: var(--arancio);
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
}

.incontro-info h4 {
    color: var(--blu-paterno);
    margin-bottom: 5px;
}

.incontro-meta {
    font-size: 0.9rem;
    color: var(--grigio);
}

.incontro-punti {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--verde-crescita);
}

/* FORM GROUPS */
.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--testo);
}

.form-group input[type="text"],
.form-group input[type="date"],
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: var(--transition);
}

.form-group textarea {
    min-height: 120px;
    resize: vertical;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--blu-paterno);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

/* CHECKBOX CUSTOM */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--grigio-chiaro);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
}

.checkbox-label:hover {
    background: #e8e8e8;
    transform: translateX(5px);
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
}

/* INFO BOX */
.info-box {
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    border-left: 5px solid var(--blu-paterno);
}

.info-box.success {
    background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
    border-left-color: var(--verde-crescita);
}

.info-box.warning {
    background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);
    border-left-color: var(--arancio);
}

.info-box h3 {
    margin-bottom: 10px;
    font-size: 1.1rem;
}

/* TIMER */
.timer-display {
    text-align: center;
    padding: 20px;
    background: var(--grigio-chiaro);
    border-radius: var(--radius);
    margin: 20px 0;
}

.timer-number {
    font-size: 3rem;
    font-weight: bold;
    color: var(--blu-paterno);
    font-family: 'Courier New', monospace;
}

.timer-label {
    font-size: 0.9rem;
    color: var(--grigio);
    margin-top: 5px;
}

/* MODAL */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-overlay.show {
    display: flex;
}

.modal-content {
    background: var(--bianco);
    padding: 40px;
    border-radius: var(--radius);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--ombra-forte);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--grigio-chiaro);
}

.modal-close {
    font-size: 2rem;
    cursor: pointer;
    color: var(--grigio);
    transition: var(--transition);
}

.modal-close:hover {
    color: var(--testo);
    transform: rotate(90deg);
}

/* RESPONSIVE */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .app-header h1 {
        font-size: 1.6rem;
    }
    
    .content-area {
        padding: 20px 15px;
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .fasi-overview {
        grid-template-columns: 1fr;
    }
    
    .nav-tabs {
        flex-wrap: wrap;
    }
    
    .nav-tab {
        flex: 1 1 45%;
    }
    
    .coppia-row {
        flex-direction: column;
        align-items: stretch;
    }
}

/* ANIMAZIONI EXTRA */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.pulse {
    animation: pulse 2s infinite;
}

/* UTILITY CLASSES */
.text-center { text-align: center; }
.mt-20 { margin-top: 20px; }
.mb-20 { margin-bottom: 20px; }
.hidden { display: none; }
</style>
</head>
<body>

<!-- CONTENITORE PRINCIPALE -->
<div class="app-container">
    
    <!-- HEADER -->
    <div class="app-header">
        <h1>ü§ù Piattaforma Peer Tutoring</h1>
        <p class="subtitle">Valori di Paternit√† e Maternit√† Educativa</p>
        <p class="istituto">IIS Meucci Mattei - Decimomannu (CA) | Metodologie Operative SSS</p>
    </div>
    
    <!-- NAVIGATION TABS -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showPage('dashboard')">
            <span class="tab-emoji">üè†</span>
            Dashboard
        </button>
        <button class="nav-tab" onclick="showPage('fase1')">
            <span class="tab-emoji">üëã</span>
            Fase 1: Accoglienza
        </button>
        <button class="nav-tab" onclick="showPage('fase2')">
            <span class="tab-emoji">üìö</span>
            Fase 2: Affiancamento
        </button>
        <button class="nav-tab" onclick="showPage('fase3')">
            <span class="tab-emoji">üéì</span>
            Fase 3: Riflessione
        </button>
        <button class="nav-tab" onclick="showPage('archivio')">
            <span class="tab-emoji">üìÅ</span>
            Archivio
        </button>
    </div>
    
    <!-- CONTENT AREA -->
    <div class="content-area">
        
        <!-- DASHBOARD PAGE -->
        <div id="dashboard" class="page active">
            
            <!-- COPPIA INFO -->
            <div class="coppia-info" id="coppiaInfo">
                <h3 style="margin-bottom:15px;">üë• La Vostra Coppia</h3>
                <div class="coppia-row">
                    <label>üë®‚Äçüè´ Tutor:</label>
                    <input type="text" id="nomeTutor" placeholder="Nome e Cognome">
                </div>
                <div class="coppia-row">
                    <label>üë§ Tutee:</label>
                    <input type="text" id="nomeTutee" placeholder="Nome e Cognome">
                </div>
                <div class="coppia-row">
                    <label>üìÖ Data Inizio:</label>
                    <input type="date" id="dataInizio">
                </div>
                <button class="btn btn-primary mt-20" onclick="salvaCoppia()">üíæ Salva Coppia</button>
            </div>
            
            <!-- DASHBOARD CARDS -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>üéØ Punti Totali</h3>
                    <div class="big-number" id="puntiTotali">0</div>
                    <div class="label">su 500 disponibili</div>
                </div>
                
                <div class="dashboard-card">
                    <h3>üèÜ Badge Ottenuti</h3>
                    <div class="big-number" id="badgeTotali">0</div>
                    <div class="label">su 10 totali</div>
                </div>
                
                <div class="dashboard-card">
                    <h3>üìä Progresso</h3>
                    <div class="big-number" id="progressoPerc">0%</div>
                    <div class="label">Completamento percorso</div>
                </div>
            </div>
            
            <!-- PROGRESS BAR -->
            <div class="progress-section">
                <h3>üìà Avanzamento Percorso</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">
                        <span class="progress-bar-text">0%</span>
                    </div>
                </div>
            </div>
            
            <!-- FASI OVERVIEW -->
            <h3 style="margin: 30px 0 20px 0;">üó∫Ô∏è Le Tre Fasi del Percorso</h3>
            <div class="fasi-overview">
                <div class="fase-card in-corso" onclick="showPage('fase1')">
                    <div class="fase-emoji">üëã</div>
                    <h4>Fase 1: Accoglienza</h4>
                    <p style="color:var(--grigio);margin:10px 0;">3 incontri per conoscersi</p>
                    <span class="fase-status in-corso">In Corso</span>
                </div>
                
                <div class="fase-card bloccata">
                    <div class="fase-emoji">üìö</div>
                    <h4>Fase 2: Affiancamento</h4>
                    <p style="color:var(--grigio);margin:10px 0;">12-14 sessioni di studio</p>
                    <span class="fase-status bloccata">Bloccata</span>
                </div>
                
                <div class="fase-card bloccata">
                    <div class="fase-emoji">üéì</div>
                    <h4>Fase 3: Riflessione</h4>
                    <p style="color:var(--grigio);margin:10px 0;">Valutazione finale</p>
                    <span class="fase-status bloccata">Bloccata</span>
                </div>
            </div>
            
            <!-- BADGE SHOWCASE -->
            <h3 style="margin: 30px 0 20px 0;">üèÜ I Vostri Badge</h3>
            <div class="badges-container" id="badgesContainer">
                <!-- I badge verranno popolati dinamicamente -->
            </div>
            
            <!-- AZIONI RAPIDE -->
            <div style="margin-top:40px;text-align:center;">
                <button class="btn btn-success" onclick="esportaTutto()">üì• Esporta Diario Completo</button>
                <button class="btn btn-danger" onclick="resetPercorso()" style="margin-left:10px;">üîÑ Reset Percorso</button>
            </div>
            
        </div>
        
        <!-- FASE 1 PAGE -->
        <div id="fase1" class="page">
            <h2 style="color:var(--blu-paterno);margin-bottom:20px;">üëã Fase 1: Accoglienza</h2>
            
            <div class="info-box">
                <h3>üí° Obiettivo della Fase</h3>
                <p>Costruire una relazione di fiducia attraverso 3 incontri strutturati. Conoscervi reciprocamente, definire ruoli e impegni, creare il vostro patto formativo.</p>
            </div>
            
            <div class="incontri-list">
                <div class="incontro-item in-corso" onclick="apriIncontro(1, 1)">
                    <div class="incontro-info">
                        <h4>ü§ù Incontro 1: Ice-Breaker e Manifesto</h4>
                        <p class="incontro-meta">‚è±Ô∏è 45 minuti | Conosciamoci e definiamo i valori</p>
                    </div>
                    <div class="incontro-punti">30 punti</div>
                </div>
                
                <div class="incontro-item" onclick="apriIncontro(1, 2)">
                    <div class="incontro-info">
                        <h4>üìñ Incontro 2: Le Nostre Storie</h4>
                        <p class="incontro-meta">‚è±Ô∏è 60 minuti | Condividiamo esperienze e risorse</p>
                    </div>
                    <div class="incontro-punti">40 punti</div>
                </div>
                
                <div class="incontro-item" onclick="apriIncontro(1, 3)">
                    <div class="incontro-info">
                        <h4>üìú Incontro 3: Patto Formativo</h4>
                        <p class="incontro-meta">‚è±Ô∏è 45 minuti | Obiettivi e regole condivise</p>
                    </div>
                    <div class="incontro-punti">30 punti</div>
                </div>
            </div>
        </div>
        
        <!-- FASE 2 PAGE -->
        <div id="fase2" class="page">
            <h2 style="color:var(--blu-paterno);margin-bottom:20px;">üìö Fase 2: Affiancamento</h2>
            
            <div class="info-box warning">
                <h3>‚ö†Ô∏è Fase Bloccata</h3>
                <p>Completa tutti gli incontri della Fase 1 per sbloccare l'affiancamento.</p>
            </div>
            
            <div class="text-center mt-20">
                <button class="btn btn-secondary" onclick="showPage('fase1')">‚Üê Torna alla Fase 1</button>
            </div>
        </div>
        
        <!-- FASE 3 PAGE -->
        <div id="fase3" class="page">
            <h2 style="color:var(--blu-paterno);margin-bottom:20px;">üéì Fase 3: Riflessione Finale</h2>
            
            <div class="info-box warning">
                <h3>‚ö†Ô∏è Fase Bloccata</h3>
                <p>Completa almeno 10 sessioni della Fase 2 per accedere alla riflessione finale.</p>
            </div>
            
            <div class="text-center mt-20">
                <button class="btn btn-secondary" onclick="showPage('dashboard')">‚Üê Torna alla Dashboard</button>
            </div>
        </div>
        
        <!-- ARCHIVIO PAGE -->
        <div id="archivio" class="page">
            <h2 style="color:var(--blu-paterno);margin-bottom:20px;">üìÅ Archivio Incontri</h2>
            
            <div class="info-box">
                <h3>üìö Storico Completo</h3>
                <p>Qui troverai tutti gli incontri completati con possibilit√† di rileggere i contenuti salvati.</p>
            </div>
            
            <div id="archivioList" class="incontri-list">
                <p style="text-align:center;color:var(--grigio);padding:40px;">Nessun incontro completato ancora. Inizia dalla Fase 1!</p>
            </div>
        </div>
        
    </div>
    
</div>

<!-- MODAL PER INCONTRI -->
<div class="modal-overlay" id="modalIncontro">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Titolo Incontro</h2>
            <span class="modal-close" onclick="chiudiModal()">&times;</span>
        </div>
        <div id="modalBody">
            <!-- Contenuto dinamico -->
        </div>
    </div>
</div>

<input type="hidden" id="peerTutoringState" name="peerTutoringState" value="">

<script>
// =============================================
// VARIABILI GLOBALI
// =============================================
const LOCAL_STORAGE_KEY = 'peerTutoringData';
const PROGRESS_STATE_KEY = 'peerTutoringState';

const DEFAULT_APP_DATA = {
    coppia: {
        tutor: '',
        tutee: '',
        dataInizio: ''
    },
    punti: 0,
    badge: [],
    fase1: {
        incontro1: { completato: false, data: null, dati: {} },
        incontro2: { completato: false, data: null, dati: {} },
        incontro3: { completato: false, data: null, dati: {} }
    },
    fase2: {
        sessioni: []
    },
    fase3: {
        completato: false,
        data: null,
        dati: {}
    }
};

let appData = cloneDefaultState();

const pageMeta = document.querySelector('meta[name="page-id"]');
const PAGE_ID = (pageMeta && pageMeta.content) ? pageMeta.content : window.location.pathname;
let stateInput = null;

// Badge disponibili
const BADGES = [
    { id: 'costruttore', emoji: 'ü§ù', nome: 'Costruttore di Ponti', requisito: 'Completa Incontro 1' },
    { id: 'ascoltatore', emoji: 'üéß', nome: 'Ascoltatore Empatico', requisito: 'Completa Incontro 2 - Momento 2' },
    { id: 'custode', emoji: 'üåü', nome: 'Custode della Relazione', requisito: 'Completa Incontro 2' },
    { id: 'architetto', emoji: 'üìú', nome: 'Architetto del Percorso', requisito: 'Completa Incontro 3' },
    { id: 'apprendista', emoji: 'üå±', nome: 'Apprendista Costante', requisito: '5 sessioni Fase 2' },
    { id: 'duo', emoji: 'üî•', nome: 'Duo Inarrestabile', requisito: '10 sessioni Fase 2' },
    { id: 'maestri', emoji: 'üíé', nome: 'Maestri della Collaborazione', requisito: '15 sessioni Fase 2' },
    { id: 'riflettore', emoji: 'üß†', nome: 'Riflettore Critico', requisito: 'Completa Fase 3' },
    { id: 'mentore', emoji: 'üë®‚Äçüè´', nome: 'Mentore Certificato', requisito: 'Completa tutto il percorso' },
    { id: 'innovatore', emoji: 'üí°', nome: 'Innovatore Educativo', requisito: 'Tutte le sfide extra' }
];

// =============================================
// INIZIALIZZAZIONE
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    stateInput = document.getElementById(PROGRESS_STATE_KEY);
    caricaDati();
});

window.addEventListener('mo:progress-restored', function(event) {
    const detail = event && event.detail ? event.detail : {};
    if (detail.pageId && detail.pageId !== PAGE_ID) {
        return;
    }

    if (detail.data && detail.data[PROGRESS_STATE_KEY]) {
        try {
            const restored = JSON.parse(detail.data[PROGRESS_STATE_KEY]);
            applyStateObject(restored);
            console.log('üì• Stato ripristinato dalla piattaforma Supabase');
        } catch (error) {
            console.warn('Impossibile ripristinare lo stato salvato:', error);
        }
    } else if (!detail.data) {
        syncProgressState();
    }
});

// =============================================
// GESTIONE DATI
// =============================================
function cloneDefaultState() {
    return JSON.parse(JSON.stringify(DEFAULT_APP_DATA));
}

function writeLocalStorage() {
    try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
    } catch (error) {
        console.error('Errore nel salvataggio locale:', error);
    }
}

function syncProgressState() {
    if (!stateInput) {
        return;
    }
    try {
        stateInput.value = JSON.stringify(appData);
    } catch (error) {
        console.error('Impossibile aggiornare lo stato dei progressi:', error);
    }
}

function populateCoppiaFields() {
    const tutorInput = document.getElementById('nomeTutor');
    const tuteeInput = document.getElementById('nomeTutee');
    const dataInput = document.getElementById('dataInizio');
    const infoBox = document.getElementById('coppiaInfo');

    if (tutorInput) {
        tutorInput.value = appData.coppia && appData.coppia.tutor ? appData.coppia.tutor : '';
    }
    if (tuteeInput) {
        tuteeInput.value = appData.coppia && appData.coppia.tutee ? appData.coppia.tutee : '';
    }
    if (dataInput) {
        dataInput.value = appData.coppia && appData.coppia.dataInizio ? appData.coppia.dataInizio : '';
    }
    if (infoBox) {
        if (appData.coppia && appData.coppia.tutor) {
            infoBox.classList.remove('not-set');
        } else {
            infoBox.classList.add('not-set');
        }
    }
}

function applyStateObject(state, options) {
    if (!state || typeof state !== 'object') {
        return;
    }
    const opts = options && typeof options === 'object' ? options : {};
    const merged = cloneDefaultState();

    if (state.coppia && typeof state.coppia === 'object') {
        merged.coppia = Object.assign({}, merged.coppia, state.coppia);
    }

    merged.punti = typeof state.punti === 'number' ? state.punti : merged.punti;
    merged.badge = Array.isArray(state.badge) ? state.badge.slice() : merged.badge;

    if (state.fase1 && typeof state.fase1 === 'object') {
        const fase1 = Object.assign({}, merged.fase1);
        Object.keys(fase1).forEach(function(key) {
            if (state.fase1[key] && typeof state.fase1[key] === 'object') {
                fase1[key] = Object.assign({}, fase1[key], state.fase1[key]);
            }
        });
        merged.fase1 = fase1;
    }

    if (state.fase2 && typeof state.fase2 === 'object') {
        merged.fase2 = {
            sessioni: Array.isArray(state.fase2.sessioni) ? state.fase2.sessioni.slice() : merged.fase2.sessioni
        };
    }

    if (state.fase3 && typeof state.fase3 === 'object') {
        merged.fase3 = Object.assign({}, merged.fase3, state.fase3);
        if (state.fase3.dati && typeof state.fase3.dati === 'object') {
            merged.fase3.dati = Object.assign({}, merged.fase3.dati, state.fase3.dati);
        }
    }

    appData = merged;

    if (!opts.skipLocalSave) {
        writeLocalStorage();
    }

    populateCoppiaFields();
    aggiornaDashboard();
    renderBadges();

    if (!opts.skipSync) {
        syncProgressState();
    }
}

function salvaDati() {
    writeLocalStorage();
    syncProgressState();
    console.log('‚úÖ Dati salvati');
}

function caricaDati() {
    const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            applyStateObject(parsed, { skipLocalSave: true });
            console.log('üì• Dati caricati');
            return;
        } catch (error) {
            console.error('Errore nel caricamento locale:', error);
        }
    }

    appData = cloneDefaultState();
    populateCoppiaFields();
    aggiornaDashboard();
    renderBadges();
    syncProgressState();
}

function salvaCoppia() {
    const tutor = document.getElementById('nomeTutor').value.trim();
    const tutee = document.getElementById('nomeTutee').value.trim();
    const dataInizio = document.getElementById('dataInizio').value;
    
    if (!tutor || !tutee || !dataInizio) {
        alert('‚ö†Ô∏è Compila tutti i campi della coppia!');
        return;
    }
    
    appData.coppia = { tutor, tutee, dataInizio };
    salvaDati();
    document.getElementById('coppiaInfo').classList.remove('not-set');
    
    alert('‚úÖ Coppia salvata con successo!');
}

// =============================================
// NAVIGAZIONE
// =============================================
function showPage(pageId) {
    // Nascondi tutte le pagine
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Mostra la pagina richiesta
    document.getElementById(pageId).classList.add('active');
    
    // Aggiorna tab attiva
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.closest('.nav-tab').classList.add('active');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// =============================================
// DASHBOARD
// =============================================
function aggiornaDashboard() {
    // Aggiorna contatori
    document.getElementById('puntiTotali').textContent = appData.punti;
    document.getElementById('badgeTotali').textContent = appData.badge.length;
    
    // Calcola progresso
    const progressoPerc = Math.round((appData.punti / 500) * 100);
    document.getElementById('progressoPerc').textContent = progressoPerc + '%';
    document.getElementById('progressBarFill').style.width = progressoPerc + '%';
    document.getElementById('progressBarFill').querySelector('.progress-bar-text').textContent = progressoPerc + '%';
}

function renderBadges() {
    const container = document.getElementById('badgesContainer');
    container.innerHTML = '';
    
    BADGES.forEach(badge => {
        const earned = appData.badge.includes(badge.id);
        const div = document.createElement('div');
        div.className = `badge-item ${earned ? 'earned' : 'locked'}`;
        div.title = badge.requisito;
        div.innerHTML = `
            <span class="badge-emoji">${badge.emoji}</span>
            <div class="badge-name">${badge.nome}</div>
        `;
        container.appendChild(div);
    });
}

function assegnaBadge(badgeId) {
    if (!appData.badge.includes(badgeId)) {
        appData.badge.push(badgeId);
        const badge = BADGES.find(b => b.id === badgeId);
        
        // Mostra notifica
        alert(`üèÜ Nuovo Badge Ottenuto!\n\n${badge.emoji} ${badge.nome}`);
        
        salvaDati();
        aggiornaDashboard();
        renderBadges();
    }
}

function aggiungiPunti(punti) {
    appData.punti += punti;
    salvaDati();
    aggiornaDashboard();
    
    // Animazione
    const el = document.getElementById('puntiTotali');
    el.style.transform = 'scale(1.3)';
    el.style.color = 'var(--verde-crescita)';
    setTimeout(() => {
        el.style.transform = 'scale(1)';
        el.style.color = 'var(--verde-crescita)';
    }, 500);
}

// =============================================
// INCONTRI
// =============================================
function apriIncontro(fase, numero) {
    const modal = document.getElementById('modalIncontro');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    
    // Verifica coppia salvata
    if (!appData.coppia.tutor) {
        alert('‚ö†Ô∏è Prima salva i dati della coppia dalla Dashboard!');
        showPage('dashboard');
        return;
    }
    
    if (fase === 1 && numero === 1) {
        modalTitle.textContent = 'ü§ù Incontro 1: Ice-Breaker e Manifesto';
        modalBody.innerHTML = generaIncontro1();
    } else if (fase === 1 && numero === 2) {
        modalTitle.textContent = 'üìñ Incontro 2: Le Nostre Storie';
        modalBody.innerHTML = generaIncontro2();
    } else if (fase === 1 && numero === 3) {
        modalTitle.textContent = 'üìú Incontro 3: Patto Formativo';
        modalBody.innerHTML = generaIncontro3();
    }
    
    modal.classList.add('show');
}

function chiudiModal() {
    document.getElementById('modalIncontro').classList.remove('show');
}

// =============================================
// CONTENUTO INCONTRI
// =============================================
function generaIncontro1() {
    return `
        <div class="info-box">
            <h3>üéØ Obiettivo</h3>
            <p>Conoscersi reciprocamente e sottoscrivere i valori del peer tutoring</p>
        </div>
        
        <div class="timer-display">
            <div class="timer-number" id="timer1">45:00</div>
            <div class="timer-label">Tempo rimanente</div>
        </div>
        
        <h3 style="margin:25px 0 15px 0;">üë®‚Äçüè´ Tutor: Presentati</h3>
        <div class="form-group">
            <label>Il tuo nome e classe</label>
            <input type="text" id="inc1_tutorNome" placeholder="Es: Mario Rossi - 4A SSS">
        </div>
        <div class="form-group">
            <label>3 tue passioni</label>
            <textarea id="inc1_tutorPassioni" placeholder="Es: Musica, sport, aiutare gli altri..."></textarea>
        </div>
        <div class="form-group">
            <label>Perch√© vuoi fare il tutor?</label>
            <textarea id="inc1_tutorMotivazione" placeholder="Cosa ti spinge a voler aiutare un compagno..."></textarea>
        </div>
        
        <h3 style="margin:25px 0 15px 0;">üë§ Tutee: Presentati</h3>
        <div class="form-group">
            <label>Il tuo nome e classe</label>
            <input type="text" id="inc1_tuteeNome" placeholder="Es: Giulia Bianchi - 1A SSS">
        </div>
        <div class="form-group">
            <label>3 tuoi interessi</label>
            <textarea id="inc1_tuteeInteressi" placeholder="Es: Leggere, disegnare, animali..."></textarea>
        </div>
        <div class="form-group">
            <label>Cosa ti aspetti dal tutoring?</label>
            <textarea id="inc1_tuteeAspettative" placeholder="Cosa speri di imparare, come vorresti essere aiutato..."></textarea>
        </div>
        
        <h3 style="margin:25px 0 15px 0;">ü§ù Insieme</h3>
        <div class="form-group">
            <label>La nostra prima impressione reciproca</label>
            <textarea id="inc1_impressione" placeholder="Come vi siete sentiti al primo incontro? Cosa vi ha colpito dell'altro?"></textarea>
        </div>
        
        <div class="info-box success" style="margin-top:30px;">
            <h3>üìú Manifesto del Tutor</h3>
            <p>Sottoscrivi questi valori fondamentali del peer tutoring:</p>
        </div>
        
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="1">
                <span>üëÇ Ascolto senza giudicare</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="2">
                <span>‚è∞ Pazienza nei momenti difficili</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="3">
                <span>ü§ù Rispetto dei tempi dell'altro</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="4">
                <span>‚è±Ô∏è Puntualit√† agli incontri</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="5">
                <span>üîí Riservatezza su quanto condiviso</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="6">
                <span>üìö Disponibilit√† a imparare anche io</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" name="manifesto" value="7">
                <span>üéâ Celebrare i successi insieme</span>
            </label>
        </div>
        
        <div class="form-group" style="margin-top:20px;">
            <label>‚úçÔ∏è Firma digitale del tutor</label>
            <input type="text" id="inc1_firma" placeholder="Io [nome] mi impegno a rispettare questi valori">
        </div>
        
        <div style="text-align:center;margin-top:30px;">
            <button class="btn btn-success" onclick="salvaIncontro1()">‚úÖ Completa Incontro 1 (30 punti)</button>
        </div>
    `;
}

function generaIncontro2() {
    return `
        <p style="text-align:center;font-size:1.2rem;color:var(--grigio);padding:40px;">
            üöß Contenuto Incontro 2 in costruzione...<br><br>
            Questo sar√† il modulo "Le Nostre Storie di Apprendimento" con i 5 momenti gi√† progettati.
        </p>
    `;
}

function generaIncontro3() {
    return `
        <p style="text-align:center;font-size:1.2rem;color:var(--grigio);padding:40px;">
            üöß Contenuto Incontro 3 in costruzione...<br><br>
            Questo sar√† il "Patto Formativo" con obiettivi e regole condivise.
        </p>
    `;
}

// =============================================
// SALVATAGGIO INCONTRI
// =============================================
function salvaIncontro1() {
    // Validazione
    const tutorNome = document.getElementById('inc1_tutorNome').value.trim();
    const tutorPassioni = document.getElementById('inc1_tutorPassioni').value.trim();
    const tutorMotivazione = document.getElementById('inc1_tutorMotivazione').value.trim();
    const tuteeNome = document.getElementById('inc1_tuteeNome').value.trim();
    const tuteeInteressi = document.getElementById('inc1_tuteeInteressi').value.trim();
    const tuteeAspettative = document.getElementById('inc1_tuteeAspettative').value.trim();
    const impressione = document.getElementById('inc1_impressione').value.trim();
    const firma = document.getElementById('inc1_firma').value.trim();
    
    const manifestoChecked = document.querySelectorAll('input[name="manifesto"]:checked').length;
    
    if (!tutorNome || !tutorPassioni || !tutorMotivazione || !tuteeNome || !tuteeInteressi || !tuteeAspettative || !impressione) {
        alert('‚ö†Ô∏è Compila tutti i campi prima di procedere!');
        return;
    }
    
    if (manifestoChecked < 7) {
        alert('‚ö†Ô∏è Il tutor deve sottoscrivere tutti i 7 valori del manifesto!');
        return;
    }
    
    if (!firma) {
        alert('‚ö†Ô∏è Inserisci la firma digitale del tutor!');
        return;
    }
    
    // Salva dati
    appData.fase1.incontro1 = {
        completato: true,
        data: new Date().toISOString(),
        dati: {
            tutorNome,
            tutorPassioni,
            tutorMotivazione,
            tuteeNome,
            tuteeInteressi,
            tuteeAspettative,
            impressione,
            firma
        }
    };
    
    // Aggiungi punti e badge
    aggiungiPunti(30);
    assegnaBadge('costruttore');
    
    salvaDati();
    chiudiModal();
    
    alert('üéâ Incontro 1 completato! Hai guadagnato 30 punti e il badge "Costruttore di Ponti"!');
}

// =============================================
// EXPORT E RESET
// =============================================
function esportaTutto() {
    if (appData.punti === 0) {
        alert('‚ö†Ô∏è Non ci sono ancora dati da esportare. Inizia gli incontri!');
        return;
    }
    
    let contenuto = `DIARIO COMPLETO PEER TUTORING
IIS Meucci Mattei - Decimomannu (CA)
Progetto: Valori di Paternit√† e Maternit√† Educativa

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üë• COPPIA
Tutor: ${appData.coppia.tutor}
Tutee: ${appData.coppia.tutee}
Data Inizio: ${appData.coppia.dataInizio}

üìä STATISTICHE
Punti Totali: ${appData.punti}/500
Badge Ottenuti: ${appData.badge.length}/10
Progresso: ${Math.round((appData.punti/500)*100)}%

üèÜ BADGE CONQUISTATI
${appData.badge.map(id => {
    const badge = BADGES.find(b => b.id === id);
    return `${badge.emoji} ${badge.nome}`;
}).join('\n')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
    
    // Aggiungi contenuti incontri se completati
    if (appData.fase1.incontro1.completato) {
        const i1 = appData.fase1.incontro1.dati;
        contenuto += `
ü§ù INCONTRO 1: ICE-BREAKER E MANIFESTO
Data: ${new Date(appData.fase1.incontro1.data).toLocaleDateString('it-IT')}

TUTOR:
Nome: ${i1.tutorNome}
Passioni: ${i1.tutorPassioni}
Motivazione: ${i1.tutorMotivazione}

TUTEE:
Nome: ${i1.tuteeNome}
Interessi: ${i1.tuteeInteressi}
Aspettative: ${i1.tuteeAspettative}

PRIMA IMPRESSIONE: ${i1.impressione}
FIRMA: ${i1.firma}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
    }
    
    contenuto += `
Generato il: ${new Date().toLocaleString('it-IT')}
Piattaforma Peer Tutoring - Prof. Picconi
`;
    
    // Download file
    const blob = new Blob([contenuto], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Diario_PeerTutoring_${appData.coppia.tutor.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function resetPercorso() {
    if (confirm('‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler resettare TUTTO il percorso? Questa azione √® irreversibile!\n\nTutti i dati, punti e badge verranno cancellati definitivamente.')) {
        if (confirm('üö® ULTIMA CONFERMA\n\nConfermi di voler cancellare tutti i dati?')) {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            location.reload();
        }
    }
}

// =============================================
// TIMER (da implementare per ogni incontro)
// =============================================
function iniziaTimer(minuti, elementId) {
    let secondiTotali = minuti * 60;
    const elemento = document.getElementById(elementId);
    
    const interval = setInterval(() => {
        secondiTotali--;
        
        const min = Math.floor(secondiTotali / 60);
        const sec = secondiTotali % 60;
        
        elemento.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        
        if (secondiTotali <= 0) {
            clearInterval(interval);
            elemento.textContent = '‚è∞ Tempo scaduto!';
            elemento.style.color = 'var(--rosa-materno)';
        }
    }, 1000);
}

// Auto-save ogni 30 secondi
setInterval(() => {
    salvaDati();
}, 30000);

console.log('‚úÖ Piattaforma Peer Tutoring caricata!');
</script>
<script>
    window.MO_PROGRESS_CONFIG = {
        pagePath: window.location.pathname,
        inputSelector: 'textarea, input:not([type="file"])'
    };
</script>
<script type="module" src="../assets/progress.js"></script>
<script type="module" src="../assets/progress-global.js"></script>

</body>
</html>
